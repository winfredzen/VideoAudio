# VideoAudio
入门文章

+ [零基础入门：实时音视频技术基础知识全面盘点](http://www.52im.net/thread-3079-1-1.html)
+ [即时通讯音视频开发（十九）：零基础，史上最通俗视频编码技术入门](http://www.52im.net/thread-2840-1-1.html)

知识点

+ libV4L摄像头YUV数据采集
+ X264编码H.264数据
+ 网络Socket通信协议基础，TCP/IP协议栈
+ TCP建立连接过程，阻塞or非阻塞套接字编程
+ 数据包的分发，私有协议的定义、协议头、组包
+ 客户端登录请求，命令通道、数据通道建立，数据接收，解码，渲染
+ TCP/IP协议栈底层实现，如何在底层实现可靠的数据传输，网络拥塞、抖动、丢包重传机制
+ FFmpeg
+ OpenGL ES渲染 shader
+ 音视频采集
+ 分析H.264 NALU数据的I帧、P帧、B帧，进行拆分，得到SPS、PPS关键数据。关键帧、非关键帧
+ MP4容器分析，AAC格式分析，AAC编码，实时转换
+ 用FFmpeg实时写AAC音频流，实时写视频流



## 基础

### RGB&YUV

参考：

+ [RGB and YUV](https://www.cnblogs.com/yunlambert/p/11234971.html)



> 为什么还需要`YUV`和`RGB`两种色彩模型呢？因为对于图像显示器来说，它是通过`RGB`模型来显示图像的。而在传输图像数据时是使用`YUV`模型的，因为`YUV`模型可以节省带宽。所以就需要采集图像时将`RGB`模型转换到`YUV`模型，显示时再将`YUV`模型转换为`RGB`模型。



### 音频相关参数

+ 采样率 - 一秒钟的采样数，常见44100，表示一秒钟的采样数据是44100个

+ 位宽 - 也叫采样位深，音频的位深度决定动态范围。我们常见的16bit，可以记录大概96分贝的动态范围

+ 通道数 - 一般是单通道或者双通道

+ 码率 - 又称为比特率，是指一个音频流中一秒钟能通过的数据量。比如128kbps，ps为每秒，kb为千位，128kbps表示的是一秒钟能传递的数据量是128千位。对于格式相同的文件来说，码率越大，音质越好

  码率 = 采样率 * 位宽 * 通道数 

+ 音频文件的大小 = 时长 * 码率 / 1024 / 8 = xx M



### 从JPEG到H.264

音视频编码卡的视频编码算法从JPEG发展到MPEG-1、MPEG-2、MPEG-4和H.264。JPEG是一种著名的图像压缩算法，主要应用于静态图像压缩，如果把它应用在运动图像上，就是通常所说的Motion-JPEG。

JPEG相当于MPEG的帧内压缩，因为没有去处时域上的冗余，所以在保证一定图像质量的同时，压缩比不高，通常只有10-30倍，但它有一个固定的优点，就是延迟在40ms，实时性很好，所以在某些特殊的场合任然可以看到它的踪影

MPEG-1为追求更高的压缩效率，更注重去除图像系列的时间冗余度





### H.264编码原理I／B／P帧 

**I帧**:**帧内编码帧** ，I帧表示关键帧，你可以理解为这⼀帧画⾯的完整保留；解码时只需要本帧数据就可以完成（因为包含完整画⾯）

特点：

+ 它是⼀个全帧压缩编码帧。它将全帧图像信息进⾏JPEG压缩编码及传输;
+ 解码时仅⽤I帧的数据就可重构完整图像
+ I帧描述了图像背景和运动主体的详情
+ I帧不需要参考其他画⾯⽽⽣成
+ I帧是P帧和B帧的参考帧(其质量直接影响到同组中以后各帧的质量)
+ I帧是帧组GOP的基础帧(第⼀帧),在⼀组中只有⼀个I帧
+ I帧不需要考虑运动⽮量
+ I帧所占数据的信息量⽐较⼤



**P帧**:**前向预测编码帧**。P帧表示的是这⼀帧跟之前的⼀个关键帧（或P帧）的差别，解码时需要⽤之前缓存的画⾯叠加上本帧定义的差别，⽣成最终画⾯。（也就是**差别帧**，**P帧没有完整画⾯数据，只有与前⼀帧的画⾯差别的数据**）



P帧特点: 

+ P帧是I帧后⾯相隔1~2帧的编码帧; 
+ P帧采⽤运动补偿的⽅法传送它与前⾯的I或P帧的差值及运动⽮量(预测误差); 
+ 解码时必须将I帧中的预测值与预测误差求和后才能重构完整的P帧图像; 
+ P帧属于前向预测的帧间编码。它只参考前⾯最靠近它的I帧或P帧; 
+ P帧可以是其后⾯P帧的参考帧,也可以是其前后的B帧的参考帧; 
+ **由于P帧是参考帧,它可能造成解码错误的扩散**; 
+ 由于是差值传送,P帧的压缩⽐较⾼。



**B帧**:**双向预测内插编码帧**。B帧是双向差别帧，也就是B帧记录的是本帧与前后帧的差别（具体⽐较复杂，有4种情况，但我这样说简单些），换⾔之，要解码B帧，不仅要取得之前的缓存画⾯，还要解码之后的画⾯，通过前后画⾯的与本帧数据的叠加取得最终的画⾯。B帧压缩率⾼，但是解码时CPU会⽐较累。

B帧以前⾯的I或P帧和后⾯的P帧为参考帧,“找出”B帧“某点”的预测值和两个运动⽮量,并取预测差值和运动⽮量传送。接收端根据运动⽮量在两个参考帧中“找出(算出)”预测值并与差值求和,得到B帧“某点”样值,从⽽可得到完整的B帧。

B帧特点

+ B帧是由前⾯的I或P帧和后⾯的P帧来进⾏预测的; 
+ B帧传送的是它与前⾯的I或P帧和后⾯的P帧之间的预测误差及运动⽮量; 
+ B帧是双向预测编码帧; 
+ B帧压缩⽐最⾼,因为它只反映丙参考帧间运动主体的变化情况,预测⽐较准确; 
+ **B帧不是参考帧,不会造成解码错误的扩散**



#### PTS DTS

参考：

+ [图解DTS和PTS](https://www.cnblogs.com/linyilong3/p/9940230.html)
+ [理解音视频 PTS 和 DTS](https://www.cnblogs.com/samirchen/p/7071824.html)

DTS、PTS 的概念如下所述：

- DTS（Decoding Time Stamp）：即**解码时间戳**，这个时间戳的意义在于告诉播放器该在什么时候解码这一帧的数据。
- PTS（Presentation Time Stamp）：即**显示时间戳**，这个时间戳用来告诉播放器该在什么时候显示这一帧的数据

需要注意的是：虽然 DTS、PTS 是用于指导播放端的行为，但它们是在编码的时候由编码器生成的。

当视频流中没有 B 帧时，通常 DTS 和 PTS 的顺序是一致的。但如果有 B 帧时，就回到了我们前面说的问题：解码顺序和播放顺序不一致了。

![006](https://github.com/winfredzen/VideoAudio/blob/main/images/006.png)























